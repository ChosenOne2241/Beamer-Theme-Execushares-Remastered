\NeedsTeXFormat{LaTeX2e}
\ProvidesClass{Template/UofMThesis_Class}[v20201230 The University of Manitoba Thesis Class]
\LoadClassWithOptions{report}
% The class file is a superclass of `report`.

\RequirePackage{cite} % Handles the space after `\cite{}` automatically.
\RequirePackage{microtype}
% Micro-adjusts font spacing.
% `microtype` does not work with `latex` and please use `pdflatex`, `lualatex` or `xelatex` instead if one compiles `Thesis.tex` using command lines.
\RequirePackage[nodisplayskipstretch, doublespacing]{setspace} % Double-spaced for text but not for mathematical formulae.
\RequirePackage{fancyhdr} % Fancy style headers.
\RequirePackage[Bjornstrup]{fncychap} % `Bjornstrup` heading styles.
\RequirePackage{epigraph} % Enables epigraphs and loads `minipage` automatically.
\RequirePackage{tocbibind} % Enables the table of contents, the list of tables, the list of figures and the bibliography to show in the bookmark.
\RequirePackage[hypcap = true, format = plain, font = sf, labelfont = bf]{caption} % Sans serif text and boldface caption labels; `hypcap` is applied to make links to tables and figures point to the right location when `hyperref` is in use.
\usepackage[framemethod = tikz]{mdframed}
% Defines custom boxed/framed environments (`notice` and `highlight`). `mdframed` renews the `theorem` environment so it has to be loaded before `amsthm`; it loads `kvoptions`, `xparse`, `etoolbox`, `color` and `tikz` automatically.
\RequirePackage{mathtools} % An add-on of `amsmath` loading `amsmath` automatically.
\RequirePackage{amsthm, amssymb}
% If `amsthm` is used with a non-AMS document class and with `amsmath`, `amsthm` must be loaded after `amsmath`, not before.
\RequirePackage[pdftex, breaklinks = true, pagebackref = true, hyperfootnotes = true]{hyperref}
% Generates hypertext marks.
% `breaklinks = true` allows links to break over lines.
% `pagebackref = true` activates back references inside the bibliography.
% `hyperfootnotes = true` makes the footnote marks into hyperlinks to the footnote text.
% With few exceptions, `hyperref` should **always** load last.
\RequirePackage{tablefootnote} % Enables proper footnote displays for `minipage`, `tabular` and even `mdframed` with `\tablefootnote{}`.
\RequirePackage[toc, page]{appendix} % Changes grouping for bookmarks of the appendix.
\RequirePackage{bookmark} % A new bookmark organization for `hyperref`.

% For debugging use only.
% \RequirePackage{refcheck}
% Shows useless labels, unlabelled equations, unused bibliography references.
% `refcheck` should be loaded after `hyperref` and all AMS-related packages.
% \RequirePackage[l2tabu, orthodox]{nag} % Warns users of common mistakes and outdated packages.

\renewcommand\DOCH % Silences the warning messages generated by `Bjornstrup`.
{
	\settowidth{\py}{\CNoV\thechapter}
	\addtolength{\py}{-6pt} % Shifts such amount of space right.
	\fboxsep = 0pt
	\colorbox{gray!30}{\rule{0pt}{40pt}\parbox[b]{\textwidth}{\hspace*{\fill}}}
	\kern -\py \raise 20pt
	\rlap{\color{gray}\CNoV\thechapter} \\
}

% Defines the theorem style using `amsthm`. Only some of frequently-used ones are listed here.
% See two links below for more information:
% https://en.wikibooks.org/wiki/LaTeX/Theorems#Theorem_styles and
% https://www.overleaf.com/learn/latex/theorems_and_proofs
\theoremstyle{plain}
\newtheorem{conjecture}{Conjecture}
\newtheorem{corollary}{Corollary}
\newtheorem{lemma}{Lemma}
\newtheorem{proposition}{Proposition}
\newtheorem{theorem}{Theorem}

\theoremstyle{definition}
\newtheorem{example}{Example}
\newtheorem{definition}{Definition}
\newtheorem{problem}{Problem}

\theoremstyle{remark}
\newtheorem{claim}{Claim}
\newtheorem{observation}{Observation}
\newtheorem{remark}{Remark}

% Enables proper footnote displays for `mdframed`.
\AfterEndEnvironment{mdframed}
{
	\tfn@tablefootnoteprintout
	\gdef\tfn@fnt{0}
}

% Sets up the `notice` environment.
\mdfdefinestyle{notice}
{
	topline = false,
	bottomline = false,
	leftline = false,
	rightline = false,
	singleextra = % A non-split frame.
	{
		\fill [black] (P-|O) circle [radius = 0.5em];
		% `P`: upper right corner; `(O)`: lower left corner.
		% `(P-|O)` or `(O|-P)`: upper left corner.
		\node at (P-|O) {\color{white}\scriptsize\bfseries i};
	},
	firstextra = % If it is a split frame, then let it draw the icon only for the first part.
	{
		\fill [black] (P-|O) circle [radius = 0.5em];
		% `P`: upper right corner; `(O)`: lower left corner.
		% `(P-|O)` or `(O|-P)`: upper left corner.
		\node at (P-|O) {\color{white}\scriptsize\bfseries i};
	},
	extra = % Always draws a left line.
	{
		\draw [very thick] (P-|O) ++ (0, -1em) -- (O);
	}
}

\newenvironment{notice}[1][Notice:] % Sets the default notice title as "Notice:".
{
	\medskip
	\begin{mdframed}[style = notice]
		\noindent{\textbf{#1}}
}
{
	\end{mdframed}
}

% Sets up the `highlight` environment.
\mdfdefinestyle{highlight}
{
	roundcorner = 5pt,
	innertopmargin = \baselineskip,
	singleextra = % A non-split frame.
	{
		\draw (P-|O) node [xshift = 1em, anchor = west, fill = gray!20, draw, rounded corners = 5pt] {\bfseries \highlighttitle};
	},
	firstextra = % If it is a split frame, then let it draw the title box only for the first part.
	{
		\draw (P-|O) node [xshift = 1em, anchor = west, fill = gray!20, draw, rounded corners = 5pt] {\bfseries \highlighttitle};
	}
}

\newenvironment{highlight}[1][]
{
	\medskip
	\newcommand{\highlighttitle}{#1}
	\begin{mdframed}[style = highlight]
}
{
	\end{mdframed}
}

\renewcommand{\epigraph}[2] % Makes epigraphs single-spaced.
{
	\vspace{\beforeepigraphskip}
	\vbox
	{
		\epigraphsize
		\begin{\epigraphflush}
			\begin{singlespace}
				\begin{minipage}{\epigraphwidth}
					\@epitext{#1} \\
					\@episource{#2}
				\end{minipage}
			\end{singlespace}
		\end{\epigraphflush}
	}
	\nointerlineskip
	\vspace*{\afterepigraphskip}
	\ifepigraphnoindent\@afterheading\fi
}

% Defines internal commands starting with `@` is to prevent users accidently from changing the macro names outside the class file.
\newcommand{\documentID}[1]{\newcommand\@documentID{#1}}
\newcommand{\degreename}[1]{\newcommand\@degreename{#1}}
\newcommand{\department}[1]{\newcommand\@department{#1}}
\newcommand{\graduationmonth}[1]{\newcommand\@graduationmonth{#1}}
\newcommand{\graduationyear}[1]{\newcommand\@graduationyear{#1}}
\newcommand{\advisor}[1]{\newcommand\@advisor{#1}}
\newcommand{\subject}[1]{\newcommand\@subject{#1}}
\newcommand{\keywords}[1]{\newcommand\@keywords{#1}}

\input{Front_Matter/Fields} % Loads fields mainly used in the title page.

% Exception handling starts.
\ifdefempty{\@documentID}
{
	\ClassError{UMThesis_Class}{\noexpand\documentID cannot be blank}{Check \noexpand\documentID in ./Front_Matter/Fields.tex}
	\stop
}
{}

\ifdefempty{\@degreename}
{
	\ClassError{UMThesis_Class}{\noexpand\degreename cannot be blank}{Check \noexpand\degreename in ./Front_Matter/Fields.tex}
	\stop
}
{}

\ifdefempty{\@department}
{
	\ClassError{UMThesis_Class}{\noexpand\department cannot be blank}{Check \noexpand\department in ./Front_Matter/Fields.tex}
	\stop
}
{}

\ifdefempty{\@graduationmonth}
{
	\ClassError{UMThesis_Class}{\noexpand\graduationmonth cannot be blank}{Check \noexpand\graduationmonth in ./Front_Matter/Fields.tex}
	\stop
}
{}

\ifdefempty{\@graduationyear}
{
	\ClassError{UMThesis_Class}{\noexpand\graduationyear cannot be blank}{Check \noexpand\graduationyear in ./Front_Matter/Fields.tex}
	\stop
}
{}

\ifdefempty{\@advisor}
{
	\ClassError{UMThesis_Class}{\noexpand\advisor cannot be blank}{Check \noexpand\advisor in ./Front_Matter/Fields.tex}
	\stop
}
{}

\ifnumequal{\@documentID}{0} % Defines `\@document` based on the value of `\@documentID`.
{\newcommand{\@document}{thesis}}
{
	\ifnumequal{\@documentID}{1}
	{\newcommand{\@document}{dissertation}}
	{
		\ClassError{UMThesis_Class}{\noexpand\documentID is supposed to be either `0` (thesis) or `1` (dissertation)}{Check \noexpand\documentID in ./Front_Matter/Fields.tex}
		\stop
	}
}
% Exception handling ends.

\hypersetup
{
	bookmarksnumbered = true, % Adds index numbers for chapters/sections.
	colorlinks = true, % `false` for boxed links; `true` for coloured links.
	citecolor = blue, % Changes the colour of citation links into `blue` instead of default glaring `green`.
	pdfnewwindow = true, % Links are opened in a new window.
	pdfauthor = \@author,
	pdfcreator = \@author,
	pdftitle = \@title,
	pdfsubject = \@subject,
	pdfkeywords = \@keywords,
	pdfborder = 0 0 0 % Makes all links invisible, so the document looks decent when printed.
}

\newcommand{\maketitlepage}
{
	\phantomsection
	% Adds a phantom section to display the bookmark correctly with `hyperref`.
	\addcontentsline{toc}{chapter}{Title Page}
	\begin{titlepage}
		\begin{center}
			{\LARGE \bfseries \@title} \\[2em]
			by \\[2em]
			\@author \\[2em]
			A \@document\ submitted to \\
			The Faculty of Graduate Studies of \\
			The University of Manitoba \\
			in partial fulfillment of the requirements \\
			for the degree of \\[2em]
			\@degreename \\[2em]
			\@department \\
			The University of Manitoba \\
			Winnipeg, Manitoba, Canada \\
			\@graduationmonth\ \@graduationyear \\[6em]
			Copyright \copyright\ \@graduationyear\ \@author \\
		\end{center}
	\end{titlepage}
}

\renewenvironment{abstract}
{
	\phantomsection
	\addcontentsline{toc}{chapter}{Abstract}
	\noindent
	\begin{minipage}[t]{0.45\textwidth}
		\begin{flushleft}
			{\expandafter \MakeUppercase \@document} Advisor \\
			{\bfseries \@advisor}
		\end{flushleft}
	\end{minipage}
	\hspace{\fill}
	\begin{minipage}[t]{0.45\textwidth}
		\begin{flushright}
			Author \\
			{\bfseries \@author}
		\end{flushright}
	\end{minipage}
	\vspace{2em}
	\begin{center}
		{\large \bfseries \@title}
	\end{center}
	\vspace{2em}
	\begin{center}
		{\Large \bfseries \abstractname}
	\end{center}
}
{
	\ifdefempty{\@keywords}
	{}
	{
		\\[2em]
		\textbf{Keywords:} \@keywords
	}
}

\newenvironment{acknowledgements}
{
	\phantomsection
	\addcontentsline{toc}{chapter}{Acknowledgements}
	\chapter*{Acknowledgements}
}
{}

\newenvironment{dedication}
{
	\phantomsection
	\addcontentsline{toc}{chapter}{Dedication}
	\begin{quote}
		\begin{flushright}
			\em
}
{
		\end{flushright}
	\end{quote}
}

\newcommand{\frontmatterpagestyle}
{
	\pagestyle{plain}
	\pagenumbering{roman} % Page numbers for the front matter are roman.
}

\newcommand{\mainmatterpagestyle}
{
	\pagestyle{fancy}
	\setlength{\headheight}{15pt} % Sets `\headheight` to 15pt to get rid of the headheight-related warning message caused by `fancyhdr`, when the default font size is 12pt.
	\cfoot{}
	\renewcommand{\chaptermark}[1]{\markboth{##1}{##1}} % Nested commands.
	\fancyhead[LE, RO]{\thepage}
	\fancyhead[LO, RE]{\textit{\chaptername\ \thechapter: \leftmark}}
	% Three lines above create the fancy style header for two-side documents.
	\pagenumbering{arabic} % Page numbers for the main/back matter are arabic.
}

\newcommand{\backmatterpagestyle}
{
	\pagestyle{plain}
	\bibliographystyle{abbrv}
}

\endinput % LaTeX will stop loading anything after this line.
